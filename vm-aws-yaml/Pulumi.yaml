name: vm-aws-yaml
description: A YAML program to create a virtual machine on AWS
runtime: yaml

template: 
    description: A YAML program to create a virtual machine on AWS
    config:
        aws:region:
            description: The AWS region to deploy into
            default: us-west-2
        instanceType:
            description: Instance type of EC2
            default: t2.micro
        vpcNetworkCidr:
            description: Network CIDR to use for new VPC
            default: 10.0.0.0/16

configuration:
    instanceType:
        type: String
        default: t2.micro
    vpcNetworkCidr:
        type: String
        default: 10.0.0.0/16

resources:  
    # Create VPC
    vpc:
        type: aws:ec2:Vpc
        properties:
            cidrBlock: 10.0.0.0/16
            enableDnsHostnames: true
            enableDnsSupport: true 
    # Create an internet gateway
    gateway:
        type: aws:ec2:InternetGateway
        properties:
            vpcId: ${vpc.id}
            tags:
                Name: vm-aws-yaml-ig
    # Create a subnet that automatically assigns new instances a public IP address.
    subnet:
        type: aws:ec2:Subnet
        properties:
            vpcId: ${vpc.id}
            cidrBlock: 10.0.1.0/24
            mapPublicIpOnLaunch: true
            tags:
                Name: vm-aws-yaml-subnet
    # Create a route table
    routeTable:
        type: aws:ec2:RouteTable
        properties:
            vpcId: ${vpc.id}
            routes:
                - cidrBlock: 0.0.0.0/0
                  gatewayId: ${gateway.id}
            tags:
                Name: vm-aws-yaml-routetable
    # Associate the route table with the public subnet.
    routeTableAssociation:
        type: aws:ec2:RouteTableAssociation
        properties:
            subnetId: ${subnet.id}
            routeTableId: ${routeTable.id}
    # Create EC2 Security Group
    secGroup:
        type: aws:ec2:SecurityGroup
        properties:
            description: Enable HTTP access
            vpcId: ${vpc.id}
            ingress:
                - fromPort: 80
                  toPort: 80
                  protocol: tcp
                  cidrBlocks: 
                    - 0.0.0.0/0
            egress:
                - fromPort: 0
                  toPort: 0
                  protocol: -1
                  cidrBlocks:
                    - 0.0.0.0/0
            tags:
                Name: vm-aws-yaml-secgrp
    # Create EC2 server
    server:
        type: aws:ec2:Instance
        properties:
            instanceType: ${instanceType}
            subnetId: ${subnet.id}
            vpcSecurityGroupIds: 
                - ${secGroup}
            userData: ${userData}
            ami: ${ami}
            tags:
                Name: vm-aws-yaml-webserver

variables:
    # Create EC2 AMI
    ami:
        fn::invoke:
            function: aws:ec2:getAmi
            arguments:
                filters:
                    - name: name
                      values: 
                        - "amzn-ami-hvm-*"
                owners: 
                    - "137112412989"
                mostRecent: true
            return: id    
    # User data to start a HTTP server in the EC2 instance
    userData: "#!/bin/bash
            
            echo \"Hello, World from Pulumi!\" > index.html
            
            nohup python -m SimpleHTTPServer 80 &"
            

outputs:
    # Export the public IP and DNS
    publicIP: ${server.publicIp}
    publicDNS: ${server.publicDns}